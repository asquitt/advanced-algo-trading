input {
  # File input for application logs
  file {
    path => "/logs/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    tags => ["application"]
  }

  # File input for trading logs
  file {
    path => "/logs/trading/*.log"
    start_position => "beginning"
    sincedb_path => "/dev/null"
    codec => json
    tags => ["trading"]
  }

  # TCP input for real-time logs
  tcp {
    port => 5000
    codec => json
    tags => ["tcp"]
  }

  # UDP input for real-time logs
  udp {
    port => 5000
    codec => json
    tags => ["udp"]
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add timestamp
  date {
    match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss,SSS"]
    target => "@timestamp"
  }

  # Extract log level
  if [level] {
    mutate {
      uppercase => ["level"]
    }
  }

  # Add environment and service tags
  mutate {
    add_field => {
      "environment" => "production"
      "platform" => "trading"
    }
  }

  # Parse trading-specific fields
  if "trading" in [tags] {
    # Extract symbol, signal type, etc.
    if [symbol] {
      mutate {
        add_field => { "security_symbol" => "%{symbol}" }
      }
    }

    if [signal_type] {
      mutate {
        add_field => { "trade_signal" => "%{signal_type}" }
      }
    }

    # Add trading session tag
    ruby {
      code => "
        hour = event.get('@timestamp').hour
        if hour >= 9 && hour < 16
          event.set('trading_session', 'market_hours')
        elsif hour >= 4 && hour < 9
          event.set('trading_session', 'pre_market')
        elsif hour >= 16 && hour < 20
          event.set('trading_session', 'after_hours')
        else
          event.set('trading_session', 'closed')
        end
      "
    }
  }

  # Parse error logs
  if [level] == "ERROR" or [level] == "CRITICAL" {
    mutate {
      add_tag => ["error"]
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["message", "host"]
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "trading-logs-%{+YYYY.MM.dd}"
    document_type => "_doc"
  }

  # Debug output (optional, comment out in production)
  # stdout { codec => rubydebug }
}
